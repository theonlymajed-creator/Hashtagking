<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majed's Hashtag Brain AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .setup-screen {
            padding: 40px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .setup-screen h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .setup-screen input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .setup-screen button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .setup-screen button:hover {
            opacity: 0.9;
        }

        .setup-screen a {
            color: #667eea;
            margin-top: 15px;
            display: inline-block;
        }

        .chat-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        .chat-container.active {
            display: flex;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .input-area button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .input-area button:hover {
            opacity: 0.9;
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .commands {
            padding: 10px 20px;
            background: #f0f0f0;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            background: #fee;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 MAJED'S HASHTAG BRAIN AI</h1>
            <p>Your personal AI that learns your TikTok page</p>
        </div>

        <div class="setup-screen" id="setupScreen">
            <h2>Setup Your AI</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Paste your Claude API key to get started
            </p>
            <input 
                type="password" 
                id="apiKeyInput" 
                placeholder="sk-ant-api03-..."
                autocomplete="off"
            />
            <button onclick="saveApiKey()">Start Chatting</button>
            <a href="https://console.anthropic.com/settings/keys" target="_blank">
                Get your API key here →
            </a>
            <div id="setupError"></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="messages" id="messages"></div>
            <div class="commands">
                Commands: "track" to log performance | "knowledge" to see what I know | "reset" to clear API key
            </div>
            <div class="input-area">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Type your message..."
                    onkeypress="handleKeyPress(event)"
                />
                <button onclick="sendMessage()" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize knowledge base
        let knowledge = {
            page_info: {
                handle: "@theonlymajed",
                followers: "9M",
                content_type: "Music reactions, ratings, phonk/EDM curator",
                vibe: "NPC-style reactions, emotionless delivery, underground music focus",
                brand: "Cool, aggressive, underground but stylish"
            },
            hashtag_performance: {
                always_use: ["#majed", "#theonlymajed", "#rating", "#reaction"],
                high_performers: ["#phonk", "#electronicmusic", "#edm", "#techhouse", "#dubstep", "#bassmusic"],
                medium_performers: ["#fyp", "#foryoupage", "#musictiktok", "#edmtiktok"],
                avoid: [],
                genre_specific: {
                    phonk: ["#phonk", "#phonk_music", "#brazilianphonk", "#funk", "#funkbrasil"],
                    house: ["#housemusic", "#techhouse", "#electronicmusic"],
                    dubstep: ["#dubstep", "#bassmusic", "#riddim"],
                    general_edm: ["#edm", "#electronicmusic", "#edmtiktok"]
                }
            },
            video_performance: [],
            learned_patterns: []
        };

        let conversationHistory = [];
        let apiKey = localStorage.getItem('claude_api_key');

        // Load saved data
        function loadData() {
            const savedKnowledge = localStorage.getItem('majed_knowledge');
            const savedHistory = localStorage.getItem('majed_conversations');
            
            if (savedKnowledge) {
                knowledge = JSON.parse(savedKnowledge);
            }
            if (savedHistory) {
                conversationHistory = JSON.parse(savedHistory);
            }
        }

        // Save data
        function saveData() {
            localStorage.setItem('majed_knowledge', JSON.stringify(knowledge));
            localStorage.setItem('majed_conversations', JSON.stringify(conversationHistory));
        }

        // Check if setup is done
        function checkSetup() {
            loadData();
            if (apiKey) {
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('chatContainer').classList.add('active');
                
                // Restore conversation
                conversationHistory.forEach(msg => {
                    addMessage(msg.role, msg.content, false);
                });
            }
        }

        // Save API key
        async function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            const errorDiv = document.getElementById('setupError');
            
            if (!key.startsWith('sk-ant-')) {
                errorDiv.innerHTML = 
                    '<div class="error">Invalid API key format. It should start with "sk-ant-"</div>';
                return;
            }
            
            // Test the API key
            errorDiv.innerHTML = '<div style="color: #667eea; padding: 10px;">Testing API key...</div>';
            
            try {
                const testResponse = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': key,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 10,
                        messages: [{ role: 'user', content: 'Hi' }]
                    })
                });
                
                if (!testResponse.ok) {
                    const errorData = await testResponse.json().catch(() => ({}));
                    let errorMsg = errorData.error?.message || 'API test failed';
                    
                    if (errorMsg.includes('credit') || errorMsg.includes('quota')) {
                        errorMsg = 'No credits available. Add payment method at console.anthropic.com/settings/billing';
                    } else if (errorMsg.includes('authentication') || errorMsg.includes('api_key')) {
                        errorMsg = 'Invalid API key. Get a new one from console.anthropic.com/settings/keys';
                    }
                    
                    errorDiv.innerHTML = `<div class="error">❌ ${errorMsg}</div>`;
                    return;
                }
                
                // Success!
                localStorage.setItem('claude_api_key', key);
                apiKey = key;
                checkSetup();
                
            } catch (error) {
                errorDiv.innerHTML = 
                    `<div class="error">❌ Connection error: ${error.message}<br><br>Check your internet connection.</div>`;
            }
        }

        // Add message to UI
        function addMessage(role, content, save = true) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (save) {
                conversationHistory.push({ role, content, timestamp: new Date().toISOString() });
                saveData();
            }
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Handle special commands
            if (message.toLowerCase() === 'reset') {
                if (confirm('Reset API key and clear all data?')) {
                    localStorage.clear();
                    location.reload();
                }
                return;
            }
            
            if (message.toLowerCase() === 'knowledge') {
                addMessage('user', message);
                addMessage('ai', '```json\n' + JSON.stringify(knowledge, null, 2) + '\n```');
                input.value = '';
                return;
            }
            
            if (message.toLowerCase() === 'track') {
                addMessage('user', message);
                addMessage('ai', '📹 To track performance, tell me:\n• Hashtags used\n• View count\n• What the video was about\n\nExample: "That video with #phonk and #brazilianphonk hit 2M views, it was a phonk reaction"');
                input.value = '';
                return;
            }
            
            // Disable input
            input.disabled = true;
            sendButton.disabled = true;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai';
            loadingDiv.id = 'loading';
            loadingDiv.innerHTML = '<div class="message-content"><div class="loading"></div> Thinking...</div>';
            document.getElementById('messages').appendChild(loadingDiv);
            
            try {
                const response = await callClaude(message);
                document.getElementById('loading').remove();
                addMessage('ai', response);
                
                // Check if we should save knowledge
                if (message.toLowerCase().includes('hit') || 
                    message.toLowerCase().includes('flopped') ||
                    message.toLowerCase().includes('views') ||
                    message.toLowerCase().includes('worked') ||
                    message.toLowerCase().includes('better')) {
                    saveData();
                }
            } catch (error) {
                document.getElementById('loading').remove();
                console.error('Full error:', error);
                let errorMessage = `❌ Error: ${error.message}`;
                
                // Add more specific error messages
                if (error.message.includes('invalid_api_key') || error.message.includes('authentication')) {
                    errorMessage += '\n\n🔑 Your API key might be invalid. Try:\n1. Type "reset"\n2. Get a fresh key from console.anthropic.com/settings/keys\n3. Make sure you copied the FULL key';
                } else if (error.message.includes('rate_limit')) {
                    errorMessage += '\n\n⏱️ Rate limit hit. Wait a minute and try again.';
                } else if (error.message.includes('insufficient_quota') || error.message.includes('credit')) {
                    errorMessage += '\n\n💳 Check your billing at console.anthropic.com/settings/billing';
                } else if (error.message.includes('model')) {
                    errorMessage += '\n\n🤖 Model access issue. Make sure your API key has access to Claude Sonnet.';
                } else {
                    errorMessage += '\n\nFull error details: ' + JSON.stringify(error, null, 2);
                }
                
                addMessage('ai', errorMessage);
            }
            
            // Re-enable input
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }

        // Call Claude API
        async function callClaude(userMessage) {
            const systemPrompt = `You are Majed's personal Hashtag Brain AI for @theonlymajed's TikTok page.

YOUR KNOWLEDGE BASE:
${JSON.stringify(knowledge, null, 2)}

YOUR MISSION:
- Give hashtag recommendations for @theonlymajed's music reaction content
- Learn from Majed's feedback about what works/doesn't work
- Track video performance and adjust recommendations
- Pull live data when needed using the search_web tool

YOUR PERSONALITY:
- Talk like a homie, short and human
- Gen Z/Gen Alpha phrasing for TikTok content
- No fluff, just facts
- Hype up the good stuff
- Be real about what works vs what doesn't

WHEN TO USE SEARCH:
- When asked about specific songs/artists you don't know well
- When checking if hashtags are trending
- When Majed asks "is this trending?" or "what's hot?"
- When you need current TikTok data
- Use the search_web tool to find this info

WHEN MAJED TELLS YOU PERFORMANCE DATA:
- Remember those hashtags performed well/poorly
- Adjust future recommendations based on it
- Example: "That video hit 2M" = those hashtags are high performers
- Example: "This one flopped" = investigate why and adjust

ALWAYS:
- Give 15-20 hashtags ranked by relevance
- Include the "always_use" hashtags
- Match the genre of the content
- Remember Majed's brand: cool, aggressive, underground, stylish`;

            const tools = [{
                name: "search_web",
                description: "Search the web for current information about songs, artists, TikTok trends, or hashtag performance. Use this when you need live data about music, trending sounds, or what's hot on TikTok right now.",
                input_schema: {
                    type: "object",
                    properties: {
                        query: {
                            type: "string",
                            description: "The search query (e.g., 'Adventure Club TikTok trending', 'emotional bass hashtags', 'Drake trending sounds 2025')"
                        }
                    },
                    required: ["query"]
                }
            }];

            const messages = [
                ...conversationHistory.slice(-10).map(msg => ({
                    role: msg.role === 'ai' ? 'assistant' : msg.role,
                    content: msg.content
                })),
                { role: 'user', content: userMessage }
            ];

            // First API call
            let response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    system: systemPrompt,
                    messages: messages,
                    tools: tools
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                const errorType = errorData.error?.type || 'unknown_error';
                throw new Error(`${errorType}: ${errorMessage}`);
            }

            let data = await response.json();

            // Handle tool use
            while (data.stop_reason === 'tool_use') {
                const toolUse = data.content.find(block => block.type === 'tool_use');
                
                if (toolUse && toolUse.name === 'search_web') {
                    // Perform web search
                    const searchQuery = toolUse.input.query;
                    const searchResults = await searchWeb(searchQuery);
                    
                    // Add assistant message with tool use
                    messages.push({
                        role: 'assistant',
                        content: data.content
                    });
                    
                    // Add tool result
                    messages.push({
                        role: 'user',
                        content: [{
                            type: 'tool_result',
                            tool_use_id: toolUse.id,
                            content: searchResults
                        }]
                    });
                    
                    // Continue conversation with tool result
                    response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            system: systemPrompt,
                            messages: messages,
                            tools: tools
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }
                    
                    data = await response.json();
                } else {
                    break;
                }
            }

            // Extract text response
            const textBlock = data.content.find(block => block.type === 'text');
            return textBlock ? textBlock.text : 'No response';
        }

        // Search the web using DuckDuckGo (free, no API key needed)
        async function searchWeb(query) {
            // Update loading message to show search
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<div class="message-content"><div class="loading"></div> Searching for: ' + query + '</div>';
            }
            
            try {
                // Using DuckDuckGo instant answer API (free, no key needed)
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                const data = await response.json();
                
                let results = '';
                
                if (data.Abstract) {
                    results += `Summary: ${data.Abstract}\n\n`;
                }
                
                if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                    results += 'Related info:\n';
                    data.RelatedTopics.slice(0, 5).forEach(topic => {
                        if (topic.Text) {
                            results += `- ${topic.Text}\n`;
                        }
                    });
                }
                
                if (!results) {
                    results = `Searched for "${query}" - General info: This appears to be related to music/TikTok trends. Based on the search, consider using genre-specific and trending hashtags.`;
                }
                
                return results;
            } catch (error) {
                return `Search error for "${query}". Providing recommendations based on stored knowledge instead.`;
            }
        }

        // Initialize on load
        checkSetup();
    </script>
</body>
</html>
